---
layout: post
title:  "ESAP部署实录"
categories: es解决方案
tags:  聚表 X哲 excelserver ESAP 集群部署 
---

* content
{:toc}

本文记录ESAP运行环境部署，相关配置信息：

1. 主服务器Hyper-V server 2012 R2；

2. 数据库服务器：Windows2003 R2 + Sql server2000 SP4；

3. ES应用服务器：Windows2003 R2 + Es 9.4；

4. 客户端：Windows XP/Windows 7。

## 网络概况
![](/img/esap-deploy-1.jpg)

* 这是一个生产环节的中型网络，除了普通PC外，还有其他各类服务器和设备，如sql server,ftp,es9.4,web server等等，为了更好的控制访问权限，启用了域控(AD)。

* 服务器各司其职，例如:数据库服务器只提供数据库服务，web服务器只提供web访问，FTP只负责文件存储功能，这样做的好处是可以避免“竞争”，提高效率。而把Esweb和数据库都安装在一台服务器上，由于“竞争”的原因，会导致二者效率皆下降。

* 基于以上分析，在部署ES软件前需要先完成数据库服务器部署（sql2ksp4），并设置ES数据库目录（C:\esdata）。
 
## ES服务器部署(首次)
* 首次部署ES应用服务器时需要勾选客户端，数据库，应用服务器。
 
![](/img/esap-deploy-2.jpg)

* 安装数据库时要注意，先填账户密码，再改数据库服务器名称，最后填数据库安装目录。

![](/img/esap-deploy-3.jpg)

> <手工输入数据库服务器和数据库目录(c:\esdata)>

* 注册并重启完成ES服务器首次部署。
 
## ES服务器部署(集群)
* 为减轻主ES主服务器压力，需部署其他ES应用服务器。这些集群服务器可以像主服务器一样访问，该功能在9.4以上版本被支持，安装时只勾选应用服务器即可。
 
![](/img/esap-deploy-4.jpg)

* 设置数据库连接参数时手工填入数据库服务器名称和登陆账号密码并测试连接。
 
![](/img/esap-deploy-5.jpg)

* 注册并重启服务器，完成部署。

* 重复以上过程完成其他集群服务器部署。
 
## 数据库备份还原
* 由于数据库服务器与ES服务器分离，所以备份还原需要先在数据库服务器上建立一个备份目录，并放入备份文件(C:\esbak\esap.bak)。
 
![](/img/esap-deploy-6.jpg)

* 在主ES应用主服务器(首次安装)上进行还原，手工输入备份文件路径。
 
![](/img/esap-deploy-7.jpg)

* 点击下一步，完成ESAP数据还原。

* 数据备份过程与上述过程相似，手工输入备份路径即可。
 
## 客户端登陆
* 一旦完成服务器端部署，就可以安装客户端访问任意一台ES服务器了。
 
![](/img/esap-deploy-8.jpg)

--ES 登陆--
 
![](/img/esap-deploy-9.jpg)

--ES 工作台--
 
## 域控与ES
* 在域环境中，域用户的权限比较低，相当于普通users组，默认情况下用户登录客户端时容易出现各权限错误。
 
![](/img/esap-deploy-10.jpg)

* 域用户的权限通过AD重新分配。

![](/img/esap-deploy-11.jpg)
 
* 为了解决域用户权限低的问题，建立两个本地域安全组，其中ADMIN组隶属本地Administrators组，PU组隶属本地Power Users组，通过组策略使之生效。如果为域用户添加ADMIN组则不存在权限问题。

* 为了限制用户行为，不能添加ADMIN组时有以下方案：

1. 在`winXP/win2003`操作系统中，把用户权限提升到Power Users组可以完美运行ES客户端了。

2. 在`win7/win2008`操作系统中，将ES客户端安装到其他非系统分区，如D盘中，并设置该目录权限为域用户可写。
