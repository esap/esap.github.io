---
layout: post
title:  "ES迁移到JU全程实录"
categories: 日志
tags:  es ju 聚表 esap 迁移
---

* content
{:toc}

本文记录了esap示例库迁移到聚表(JU)的过程。

## 迁移方案
说是"迁移"，其实是重建，因为两者的架构不一样，所以我们需要三步走：

* 从ES导出模板，导入JU；
* 重设表间公式、工作流和视图等逻辑；
* 从ES库导出数据导入JU，这里难点在于附件、图片迁移；

### 1.导出ES模板
首先从ES导出模板，这里我选择导出`ESAP_关于`模板，这个模板可以顺带导出所有其他模板。

![](/img/log13-1.jpg)

原理很简单，用一条提数公式，引用所有需要导出的模板即可。

![](/img/log13-2.jpg)

### 2.导入模板到JU
导入模板前，先要对模板进行加工，因为ES模板并不能直接导入JU，只能导入excel表样。

因此，需要把所有的`.es`后缀的文件改成`.xls`后缀，也就是正常的EXCEL表格。
![](/img/log13-3.jpg)

改名后的文件如下：

![](/img/log13-4.jpg)

接下来，就可以在聚表中重建这些模板了，导入xls文件表样。

![](/img/log13-5.jpg)

模板全部导入大概话费几分钟，重建后是这样：

![](/img/log13-6.jpg)

### 3.导入数据
通常只需要导入`主数据`，例如物料表，商品表，客户信息等。

* 一般地，设计一个批量导入模板，批量新建回写这些数据即可。

* 可以将ES库注册为JU的外部数据源，这样可以直接从ES提数。

### 4.导入图片、附件
图片、附件不能直接提数回写，这里村长使用ESAP(v3.0.22+)新增的转换工具来达成目的。

**注意：ES与JU要求安装在同一服务器上，并且ES数据库、网盘也都在该服务器**

以商品表为例，ES商品表中部分表单有图片如下：

![](/img/log13-7.jpg)

而JU商品表还没有图片，如下：

![](/img/log13-8.jpg)

我们登陆到[ESAP云管理台](http://admin.erp8.net),配置主数据库为聚表所在的库。

![](/img/log13-9.jpg)

关闭ES模式，开启JU盘，设置好路径

![](/img/log13-10.jpg)

注意，该路径应该与聚表服务器设置一致，并且聚表开启了网盘。

![](/img/log13-11.jpg)

进入`ES2JU转存工具`，设置好相关参数，确保准确无误，注意JU盘要带上`账套名`。

![](/img/log13-12.jpg)

点击`转存图片`按钮完成转存。

![](/img/log13-13.jpg)

附件同理，设置好表字段等参数后，点击`转存附件`按钮，最终完成效果如下：

![](/img/log13-14.jpg)


## 小结
* 目前从ES迁移到JU基本意味着模板重建，但是好在ES模板可以导出改名，作为表样导入，可以节省一部分重建工作。

* 迁移最麻烦的实际是图片和附件，目前ESAP3.0.22+云平台可以完成这部分工作，但只能逐个字段进行。

* 最后，迁移系统前，一定多测试，确保无误后再投入生产环境。